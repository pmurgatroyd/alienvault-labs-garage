<span style="font-size: small; font-family: Arial;">Defenses of any sort, virtual or physical, are a means of forcing your attacker to attack you on your terms, not theirs. As we build more elaborate defenses within information security, we force our attacker's hand. For instance, in many cases, implementing multi-factor authentication systems just forces the attacker to go after that system directly to achieve their goals. Take the breach at RSA, for example. It has been attributed to attackers who needed the SecurID information to go after their real targets in the defense industry.</span>

<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">Recently, our lab has been talking about Sykipot, see:</span></span></span>
<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">see:</span></span></span>
<ul>
	<li><span style="color: #000099;"><span style="font-family: Arial;"><span style="font-size: small;"><span style="text-decoration: underline;"><a href="http://labs.alienvault.com/labs/index.php/2011/are-the-sykipots-authors-obsessed-with-next-generation-us-drones/">Are the Sykipotʼs authors obsessed with next generation US drones</a></span></span></span></span><span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">? </span></span></span></li>
	<li><a href="http://labs.alienvault.com/%20labs/index.php/2011/another-sykipot-sample-likely-targeting-us-federal-agencies/"><span style="color: #000099;"><span style="font-family: Arial;"><span style="font-size: small;"><span style="text-decoration: underline;">Another Sykipot sample likely targeting US federal agencies</span></span></span></span></a></li>
</ul>
<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">As we discussed, this malware has been used to launch targeted attacks via?"spear phishing" campaigns against targets mainly in the US, since around 2007. According to our research, these attacks originate from servers in China with what appears to be the purpose of obtaining information from the defense sector: the same sector that makes extensive use of PC/SC x509 Smartcards for authentication.</span></span></span>

<span style="font-family: Arial;">Smartcards have a long history of usage in the Defense Sector, for both physical and information access management, and historically have merely forced attackers to route around the smartcard authentication system through other, more vulnerable attack vectors.</span>

<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">It should come as no surprise, then, that we recently discovered a variant of Sykipot with some new, interesting features that allow it to effectively hijack DOD and Windows smart cards. This variant, which appears to have been compiled in March 2011, has been seen in dozens of attack samples from the past year.</span></span></span>

<span style="font-family: Arial;">Like we have shown with previous Sykipot attacks, the attackers use a spear phishing campaign to get their targets to open a PDF attachment which then deposits the Sykipot malware onto their machine (the attackers here took advantage of a zero-day exploit in Adobe). Then, unlike previous strains, the malware uses a keylogger to steal PINs for thecards. When a card is inserted into the reader, the malware then acts as the authenticated user and can access sensitive information. The malware is controlled by the attackers from the command &amp; control center.</span>

Here is more detail on the attack:

<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;"><span style="text-decoration: underline;"><strong>Smartcard access</strong></span></span></span></span>

<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">The ﬁrst one is that it creates a new thread with a keylogger routine. The code is very basic, it stores the window name and the keys pressed under a ﬁle named MSF5F0.dat on an unencrypted format, example:</span></span></span>

<span style="color: #000000;"><span style="font-family: 'Courier New';"><span style="font-size: small;">Title:Internet Explorer</span></span></span>
<span style="color: #000000;"><span style="font-family: 'Courier New';"><span style="font-size: small;">www.google.es</span></span></span>
<span style="color: #000000;"><span style="font-family: 'Courier New';"><span style="font-size: small;">Title:My Computer</span></span></span>

<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">It uses the WIN32 APIʼs functions [</span></span></span><span style="color: #000000;"><span style="font-family: 'Courier New';"><span style="font-size: small;">GetKeyState, GetAsyncKeyState,</span></span></span>
<span style="color: #000000;"><span style="font-family: 'Courier New';"><span style="font-size: small;">GetForegroundWindow, GetWindowTextA</span></span></span><span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">].</span></span></span>

<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">It also saves the information contained in the clipboard using the native functions:</span></span></span>
<span style="color: #000000;"><span style="font-family: 'Courier New';"><span style="font-size: small;">OpenClipboard</span></span></span><span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">, </span></span></span><span style="color: #000000;"><span style="font-family: 'Courier New';"><span style="font-size: small;">GetClipboardData</span></span></span><span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">and </span></span></span><span style="color: #000000;"><span style="font-family: 'Courier New';"><span style="font-size: small;">CloseClipboard</span></span></span><span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">.</span></span></span>

<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">This code is very similar to other pieces of APTʼs like:</span></span></span>
<p align="CENTER"><a href="http://contagiodump.blogspot.com/2010/07/apt-activity-monitor-keylogger.html"><span style="color: #000099;"><span style="font-family: Arial;"><span style="font-size: small;"><span style="text-decoration: underline;">http://contagiodump.blogspot.com/2010/07/apt-activity-monitor-keylogger.html</span></span></span></span></a></p>
<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">Apart from this we found two more modules that attracted our attention. The ﬁrst one is capable of listing all the certificates that are stored on the windows key store:</span></span></span>

<a href="http://labs.alienvault.com/labs/wp-content/uploads/2012/01/sykipot-dump1.png"><img class="size-full wp-image-862 aligncenter" title="sykipot-dump1" src="http://labs.alienvault.com/labs/wp-content/uploads/2012/01/sykipot-dump1.png" alt="" width="361" height="595" /></a>

&nbsp;

<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">This next routine is called if the command “cl” is present on the conﬁg ﬁle fetched from th</span></span></span>e <span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">C&amp;C.</span></span></span>
<p style="text-align: center;"><a href="http://labs.alienvault.com/labs/wp-content/uploads/2012/01/sykipot-dump2.png"><img class="alignnone size-full wp-image-863" title="sykipot-dump2" src="http://labs.alienvault.com/labs/wp-content/uploads/2012/01/sykipot-dump2.png" alt="" width="741" height="183" /></a></p>
<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">When you insert a smart card into a reader attached to a Windows computer, the certiﬁcate on the smart card is registered to the local certiﬁcate store on the client computer.
</span></span></span>

<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">The second one is even more interesting:</span></span></span>
<p style="text-align: center;"><a href="http://labs.alienvault.com/labs/wp-content/uploads/2012/01/sykipot-dump3.png"><img class="size-full wp-image-864 aligncenter" title="sykipot-dump3" src="http://labs.alienvault.com/labs/wp-content/uploads/2012/01/sykipot-dump3.png" alt="" width="649" height="271" /></a><img class="size-full wp-image-866 aligncenter" title="sykipot-dump5" src="http://labs.alienvault.com/labs/wp-content/uploads/2012/01/sykipot-dump5.png" alt="" width="483" height="375" /></p>
<a href="http://labs.alienvault.com/labs/wp-content/uploads/2012/01/Screen-shot-2011-12-29-at-12.37.01-PM.png"><img class="aligncenter size-full wp-image-887" title="Screen shot 2011-12-29 at 12.37.01 PM" src="http://labs.alienvault.com/labs/wp-content/uploads/2012/01/Screen-shot-2011-12-29-at-12.37.01-PM.png" alt="" width="481" height="192" /></a>

&nbsp;

<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">It loads:</span></span></span>

<span style="color: #000000;"><span style="font-family: 'Courier New';"><span style="font-size: small;">C:\Program Files\ActivIdentity\ActivClient\acpkcs201.dll</span></span></span>

<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">(a module that handles some of the functions related with ActivIdentityʼs ActivClient solution.)</span></span></span>

<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">ActivClient is a smart card-based PKI authentication solution for compliance with:</span></span></span>
<ul>
	<li><span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;"><em>U.S. Government Smart Card Interoperability Specifications GSC-IS 2.1</em></span></span></span></li>
	<li><span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;"><em>U.S. General Services Administration (GSA) Basic Services Interface (BSI)</em></span></span></span></li>
</ul>
<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">(In fact it is one of the platforms used to support the Department of Defense common access card - DoD CAC)</span></span></span>

<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">This routine is called if the command “</span></span></span><span style="color: #000000;"><span style="font-family: 'Courier New';"><span style="font-size: small;">cm</span></span></span><span style="color: #000000;">” </span><span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">is present on the conﬁg ﬁle fetched from the C&amp;C:</span></span></span>

<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;"><a href="http://labs.alienvault.com/labs/wp-content/uploads/2012/01/Screen-shot-2011-12-30-at-2.56.39-PM.png"><img class="aligncenter size-full wp-image-888" title="Screen shot 2011-12-30 at 2.56.39 PM" src="http://labs.alienvault.com/labs/wp-content/uploads/2012/01/Screen-shot-2011-12-30-at-2.56.39-PM.png" alt="" width="744" height="211" /></a>
</span></span></span>

<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">So, the modus operandi of the attackers is listing the certificates present on the victimʼs
computer included the smartcards, stealing the PIN using the keylogger module and then
use this information to log onto remote resources protected with certificates/smartcards.</span></span></span>

<a href="http://labs.alienvault.com/labs/wp-content/uploads/2012/01/sykipot-dump6.png"><img class="size-medium wp-image-867 aligncenter" title="sykipot-dump6" src="http://labs.alienvault.com/labs/wp-content/uploads/2012/01/sykipot-dump6-300x104.png" alt="" width="300" height="104" /></a>

<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;"> To log onto protected resources they have implemented the command “krundll”, if the C&amp;C sends that command, the victim receives a new dll that implements the required code to login using the certiﬁcate and the stolen PIN. This DLL implements the “</span></span></span><span style="color: #000000;"><span style="font-family: 'Courier New';"><span style="font-size: small;">LoginFunc</span></span></span><span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">” and “</span></span></span><span style="color: #000000;"><span style="font-family: 'Courier New';"><span style="font-size: small;">GetFunc</span></span></span><span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">”. These methods will contain all the code depending on the application used:
</span></span></span>
<p style="text-align: center;"><a href="http://labs.alienvault.com/labs/wp-content/uploads/2012/01/sykipot-dump7.png"><img class="alignnone size-full wp-image-868" title="sykipot-dump7" src="http://labs.alienvault.com/labs/wp-content/uploads/2012/01/sykipot-dump7.png" alt="" width="309" height="421" /></a></p>
<p style="text-align: center;"><a href="http://labs.alienvault.com/labs/wp-content/uploads/2012/01/Screen-shot-2012-01-02-at-5.51.30-PM.png"><img class="aligncenter size-full wp-image-889" title="Screen shot 2012-01-02 at 5.51.30 PM" src="http://labs.alienvault.com/labs/wp-content/uploads/2012/01/Screen-shot-2012-01-02-at-5.51.30-PM.png" alt="" width="296" height="153" /></a></p>
<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;"><span style="text-decoration: underline;"><strong>Summary</strong></span></span></span></span>

<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">We have seen how the attackers are implementing different techniques to bypass two-factor authentication with smartcard/PIN to access protected resources on the victimʼs network. By capturing the PIN for the smartcard and binding the certificate, malware can silently use the card to authenticate to secure resources, so long as the card remains physically present in the card reader. This is similar to what Mandiant described on the 2011 M-Trends report as a “Smart Card Proxy”. While trojans that have targeted smartcards are not new, there is obvious siginficance to the targeting of a particular smartcard system in wide deployment by the US DoD and other government agencies, particularly given the nature of the information the attackers seem to be <a href="http://labs.alienvault.com/ labs/index.php/2011/another-sykipot-sample-likely-targeting-us-federal-agencies/">targeting for exfiltration. </a> </span></span></span>
<p lang="en-US"><span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;"><span style="text-decoration: underline;"><strong>Implications</strong></span></span></span></span></p>
<span style="color: #000000;"><span style="font-family: Arial;"><span style="font-size: small;">As defenses get better, attackers will continue to change their tactics to adapt, and as seen here, will hijack the very systems designed to provide more security, if necessary. An interesting by-product of this malware's necessity of having the card physically present is that attackers can only leverage it for secure authentication to target systems, during times that the user them is physically present at the workstation, making unauthorized activity that much more difficult to discern from legitimate usage. Although smart cards are designed to provide a two factor system of 'chip and pin', again we see that true two-factor authentication is not possible without a physical component that is not accessible digitally.</span></span></span>

<strong><span style="text-decoration: underline;">
</span></strong>
